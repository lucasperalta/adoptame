<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:include="admin/admHeader ::head">



</head>

<body>
<header th:replace="admin/admHeader :: header"></header>

<div class="divisor"></div>

<div class="wrapper">

    <div id="content">
        <div class="container">
            <div class="row">



                <!-- FIN MENU ADMINISTRAR-->

                <!--AGREGAR USUARIO-->

                <div class="col-md-11">

                    <h6>Crear Evento</h6>
                    <div class="card">
                        <div class="card-body">
                            <div class="row">

                                <div class="col-md-4">
                                    <label for="fecha">Dia:</label>
                                    <input class="form-control" type="text" id="dias" />
                                    <!--th:field="*{}"-->
                                </div>
                                <div class="col-md-4">
                                    <label for="horarios">Horario:</label>
                                    <input type="text" class="form-control" id="horarios" /> <!--th:field="*{}"-->

                                </div>

                                <div class="col-md-4">
                                    <label for="direccion">Direccion:</label>
                                    <input type="text" class="form-control" id="direccion" /> <!--th:field="*{}"-->
                                </div>

                                <div class="col-md-4">
                                    <label for="Lugar">Lugar:</label>
                                    <input type="text" class="form-control" id="lugar" /> <!--th:field="*{}"-->
                                </div>

                                <div class="col-md-4">
                                    <label for="barrio">Barrio:</label>
                                    <input type="text" class="form-control" id="barrio" /> <!--th:field="*{}"-->

                                </div>

                                <div class="col-md-12">
                                    <label for="consultas">Consultas:</label>
                                    <input type="text" class="form-control" id="consultas" /> <!--th:field="*{}"-->

                                </div>
                            </div>

                            <button type="button"  id="crearEvento" class="btn btn-primary float-right" style="margin-top: 20px;">Crear</button>

                        </div>
                    </div>
                </div>

            </div>

            <!-- FIN FORM AGREGAR USUARIO-->

            <!-- MENU ESTADISTICAS-->
            <div class="divisor"></div>

            <div class="row">
                <!-- FIN MENU ESTADISTICAS-->

                <!-- TABLA DE SERVICIOS INGRESADOS-->
                <div class="col-md-11">
                        <div class="row">
                            <div class="col-md-5">
                                <h6>Ingresados</h6>
                            </div>

                        </div>
                    <table  id="tablaEventos"
                            data-toggle="table"
                            data-toolbar="#toolbar"
                            class="table"
                            data-search="true"
                            data-pagination="true"
                            data-page-size="10"
                            style=" width: 1px; white-space: nowrap;"

                    >
                        <thead>
                        <tr>
                            <th data-field="id" >Id Evento</th>
                            <th data-field="dias" >Dia</th>
                            <th data-field="horarios">Horario</th>
                            <th data-field="lugar">Lugar</th>
                            <th data-field="barrio">Barrio</th>
                            <th data-field="consultas">Consultas</th>
                            <th data-formatter="TableActions">Action</th>


                        </tr>
                        </thead>

                    </table>
                </div>
            </div>
            <!-- FIN TABLA DE SERVICIOS INGRESADOS-->
        </div>
    </div>
</div>


<div class="modal editar" tabindex="-1" role="dialog" id="modalEditarUsuario">

    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar usuario</h5>
                <button type="button" class="close" onclick="cerrarModal('modalEditarUsuario')" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">

                <form id="formEditarUsuario" role="form">
                    <input type="hidden" class="form-control" id="idUsuarioEditar" />
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="nombre">Nombre:</label>
                                <input type="text" class="form-control" id="nombreUsuarioEditar" />
                            </div>
                            <div class="col-md-6">
                                <label for="nombre">Apellido:</label>
                                <input type="text" class="form-control" id="apellidoUsuarioEditar" />
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <label for="nombre">Email:</label>
                                <input type="text" class="form-control" id="emailUsuarioEditar" />
                            </div>
                            <div class="col-md-6">
                                <label for="rol">Estado:</label>
                                <select class="form-control" id="estadoUsuarioEditar" name="rol">
                                    <option value="">Seleccionar Estado</option>
                                    <option th:each="estado : ${estados}"
                                            th:value="${estado.id}"
                                            th:text="${estado.estado}"></option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="rol">Rol:</label>
                                    <select class="form-control" id="rolUsuarioEditar" name="rol">
                                        <option value="">Seleccionar rol</option>
                                        <option th:each="rol : ${roles}"
                                                th:value="${rol.id}"
                                                th:text="${rol.nombreRol}"></option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>

            </div>


            <div class="modal-footer">
                <button type="button" class="btn btn-primary " id="confirmarEditarUsuarioBtn" onclick="confirmaEditarUsuario()">Grabar</button>

                <button type="button" class="btn btn-secondary" onclick="cerrarModal('modalEditarUsuario')">Cerrar</button>
            </div>
        </div>
    </div>
</div>


<div class="modal borrar" tabindex="-1" role="dialog" id="modalBorrarUsuario">

    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Eliminar usuario</h5>
                <button type="button" class="close" onclick="cerrarModal('modalBorrarUsuario')" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p id="textoBorrarUsuario">Seguro que desea borrar este usuario?</p>
                <form id="formBorrarUsuario" role="form">
                    <input type="hidden" class="form-control" id="emailUsuarioBorrar" />
                </form>

            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-primary " id="confirmarBorrarUsuarioBtn" onclick="confirmaBorrarUsuario()">Borrar</button>

                <button type="button" class="btn btn-secondary" onclick="cerrarModal('modalBorrarUsuario')">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal alta" tabindex="-1" role="dialog" id="modalAltaEvento">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Alta de evento</h5>
                <button type="button" class="close" onclick="cerrarModal('modalAltaEvento')"  aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p id="textoAltaEvento">.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="cerrarModal('modalAltaEvento')" >Cerrar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal alta" tabindex="-1" role="dialog" id="modalRespuestaEditarUsuario">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar de usuario</h5>
                <button type="button" class="close" onclick="cerrarModal('modalRespuestaEditarUsuario')" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p id="textoEditarUsuario">.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="cerrarModal('modalRespuestaEditarUsuario')">Cerrar</button>
            </div>
        </div>
    </div>
</div>




</body>

<script type="text/javascript">

    /** ncomo estoy usando tags de ThymeLeaf si lo saco a un JS no me lo toma**/
    function TableActions (value, row, index) {
        return [


            '<a class="like"  onclick="editarEvento( \''+row.id+'\',  \''+row.nombre+'\',   \''+row.apellido+'\',   \''+row.email+'\' ,   \''+row.estado+'\' ,\''+row.rol+'\');" title="Editar usuario">',
            '<img class="options" th:src="@{/img/edit.png}" alt="check"/>',
            '</a> ',
            '<a class="danger remove" onclick="borrarUsuario(\''+row.email+ '\')" title="Borrar Usuario">',
            '<img class="options" th:src="@{/img/delete.png}" alt="cancel"/>',
            '</a>'
        ].join('');
    }


    $('#dias').datepicker({
        format:"dd-mm-yyyy",
        weekStart:0,
        startDate:"0d",
        todayBtn:"linked",
        locale:"es",
        language:"es",
        autoclose:true,
        todayHighlight:true
    });


    $(document).ready(function () { //Cuando la pagina termina de cargar y esta lista, llama a los que esta aca dentro

        $('#example').bootstrapTable( {
            language: {
                search: "Buscar:"
            }
        } );
        cargarTablaEventos();


    });

    function cargarTablaEventos() {
        $.ajax({
            type: 'GET',
            url: '../eventos/todos',
            contentType: 'application/json; charset=utf-8',

            success: function(response) {
                console.log(response)
                $('#tablaEventos').bootstrapTable('load', response);
            },
            error: function(error) {
                console.log(error);
            }
        });
    }

    $('#crearEvento').click(function() {
        var data = {

            dias : $('#dias').val(),
            horarios	: $('#horarios').val(),
            direccion	:$('#direccion').val(),
            lugar	: $('#lugar').val(),
            barrio: $('#barrio').val(),
            consultas	: $('#consultas').val()


        };
        $.ajax({
            type: 'POST',
            url: '../eventos/guardarEvento',
            data:JSON.stringify(data),

            contentType: 'application/json; charset=utf-8',
            success: function(response) {
                console.log(response)
                $('#textoAltaEvento').text(response);
                $('#modalAltaEvento').show();
                cargarTablaUsuarios();

            },
            error: function(error) {
                console.log(error);
            }
        });
    });

    function cerrarModal(nombre){
        $('#'+nombre+'').hide();
    }

    function cerrarModalBorrarUsuario(){
        $('#modalBorrarUsuario').hide();
    }

    function cerrarModalEditarUsuario(){
        $('#modalEditarUsuario').hide();
    }


    function editarEvento(id,nombre,apellido,email,estado,rol) {
        $('#idUsuarioEditar').val(id);
        $('#nombreUsuarioEditar').val(nombre);
        $('#apellidoUsuarioEditar').val(apellido);
        $('#emailUsuarioEditar').val(email);
        $("#estadoUsuarioEditar option").each(function() {
            if($(this).text() === estado) {
                $(this).attr('selected', 'selected');
            }
        });

        $("#rolUsuarioEditar option").each(function() {
            if($(this).text() === rol) {
                $(this).attr('selected', 'selected');
            }
        });

        $('#modalEditarUsuario').show();

    }


    function borrarUsuario(email) {
        $('#emailUsuarioBorrar').val(email); //cargamos el mail del usuario a borrar en un campo oculto
        //lo vamos a necesitar despues cuando confirme la accion
        $('#confirmarBorrarUsuarioBtn').show(); //si el boton de aceptar lo habiamos escondido ahora lo tenemos que mostrar
        $('#textoBorrarUsuario').text("Seguro que desea borrar este usuario?"); //ponemos el texto
        $('#modalBorrarUsuario').show();//mostramos el popup de confirmacion
    }

    function confirmaBorrarUsuario(){
        $('#modalBorrarUsuario').hide();
        var data = {
            email	: $('#emailUsuarioBorrar').val()
        };

        $.ajax({
            type: 'POST',
            url: '../usuarios/borrar',
            data:JSON.stringify(data),

            contentType: 'application/json; charset=utf-8',
            success: function(response) {
                console.log(response)
                $('#textoBorrarUsuario').text(response);//cargamos el texto de respuesta del servidor
                $('#confirmarBorrarUsuarioBtn').hide(); //escondemos el boton borrar para que no borre de nuevo el mimdo usuario
                cargarTablaUsuarios();//recargamos la tabla de usuarios actualizada
                $('#modalBorrarUsuario').show();//mostramos popup con respuesta



            },
            error: function(error) {
                console.log(error);
            }
        });
    }

    function confirmaEditarUsuario(){
        $('#modalEditarUsuario').hide();


        var data = {
            id:$('#idUsuarioEditar').val(),
            nombre:$('#nombreUsuarioEditar').val(),
            apellido:$('#apellidoUsuarioEditar').val(),
            email	: $('#emailUsuarioEditar').val(),
            estado:$('#estadoUsuarioEditar').val(),
            rol:$('#rolUsuarioEditar').val()


        };

        $.ajax({
            type: 'POST',
            url: '../usuarios/editarUsuario',
            data:JSON.stringify(data),

            contentType: 'application/json; charset=utf-8',
            success: function(response) {
                console.log(response)
                $('#textoEditarUsuario').text(response);//cargamos el texto de respuesta del servidor
                $('#modalRespuestaEditarUsuario').show();//mostramos popup con respuesta

                cargarTablaUsuarios();//recargamos la tabla de usuarios actualizada


            },
            error: function(error) {
                console.log(error);
            }
        });
    }
</script>

</html>